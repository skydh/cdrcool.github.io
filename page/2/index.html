<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="OnePiece">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="OnePiece">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="晴天">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>OnePiece</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">OnePiece</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Do you know LosAngeles morning four-point looks like?</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/ELasticsearch%E6%98%A0%E5%B0%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/12/ELasticsearch%E6%98%A0%E5%B0%84/" class="post-title-link" itemprop="url">Elasticsearch 映射</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-12 20:33:00" itemprop="dateCreated datePublished" datetime="2020-02-12T20:33:00+08:00">2020-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-21 11:52:08" itemprop="dateModified" datetime="2020-02-21T11:52:08+08:00">2020-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Mapping 类似数据库中的 schema 的定义，作用如下：</p>
<ul>
<li>定义索引中的字段的名称</li>
<li>定义字段的数据类型，如字符串、数字、布尔…</li>
<li>字段倒排索引的相关设置，如 Analyzed or Not Analyzed</li>
</ul>
<h2 id="字段数据类型"><a href="#字段数据类型" class="headerlink" title="字段数据类型"></a>字段数据类型</h2><ul>
<li><p>简单类型</p>
<ul>
<li>Text / Keyword</li>
<li>Date</li>
<li>Integer</li>
<li>Floating</li>
<li>Boolean</li>
<li>IPv4 &amp; IPv6</li>
</ul>
</li>
<li><p>复杂类型</p>
<ul>
<li>对象类型</li>
<li>嵌套类型</li>
</ul>
</li>
<li><p>特殊类型</p>
<ul>
<li>geo_point /geo_shape</li>
<li>percolator</li>
</ul>
</li>
<li><p><del>数组类型</del><br>Elasticsearch 中不提供专门的数组类型。但是任何字段，都可以包含多个相同类型的数值。</p>
</li>
</ul>
<h2 id="Dynamic-Mapping"><a href="#Dynamic-Mapping" class="headerlink" title="Dynamic Mapping"></a>Dynamic Mapping</h2><p>Dynamic Mapping，是指在写入文档前无需指定 Mapping，Elasticsearch 会自动根据文档信息推算出字段的类型。这种机制使得我们无需手动定义 Mappings。当然有时候会推算的不对，这时候就需要手动设置 Mapping 了。</p>
<p>类型的自动识别：<br>JSON 类型 | Elasticsearch 类型<br>:-: | :-:<br>字符串 | 日期格式 -&gt; Date；数字 -&gt; float || long（默认关闭）；string -&gt; text &amp; keyword<br>布尔值 | boolean<br>浮点数 | float<br>整数 | long<br>对象 | Object<br>数组 | 由第一个非空数值的类型所决定<br>空值 | 忽略</p>
<h2 id="显示指定-Mapping"><a href="#显示指定-Mapping" class="headerlink" title="显示指定 Mapping"></a>显示指定 Mapping</h2><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT index_name</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &#x2F;&#x2F; define your mappings here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建议：<br>为了减少输入的工作量，减少出错概率，可以依照以下步骤设置 Mapping：</p>
<ol>
<li>创建一个临时的 idex，写入一些样本数据;</li>
<li>通过访问 Mapping API 获得该临时文件的动态 Mapping 定义；</li>
<li>修改后用，使用该配置创建真实索引；</li>
<li>删除临时索引</li>
</ol>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><p>控制当前字段是否被索引。默认为 true。如果设置成 false，该字段不可被搜索。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;firstname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;lastname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mobile&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;index&quot;: false</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="index-options"><a href="#index-options" class="headerlink" title="index_options"></a>index_options</h4><p>控制倒排索引记录的内容，有四种不同级别的配置：</p>
<ul>
<li>doc：记录 doc id</li>
<li>freqs：记录 doc id 和 term frequencies</li>
<li>positions：记录 doc id / term frequencies / term position，用于距离查询，默认设置</li>
<li>offsets：记录 doc id / term frequencies / term position / character offsets，用于高亮显示</li>
</ul>
<p>Text 类型默认记录级别为 positions，其它类型默认为 docs。记录内容越多，占用的存储空间越大。</p>
<h4 id="null-value"><a href="#null-value" class="headerlink" title="null_value"></a>null_value</h4><p>当我们需要对 Null 值实现搜索时用到，只有 keyword 类型支持设置 null_value。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;firstname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;lastname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;mobile&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;null_value&quot;: &quot;NULL&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="copy-to"><a href="#copy-to" class="headerlink" title="copy_to"></a>copy_to</h4><p>copy_to 将字段的数值拷贝到目标字段，目标字段不出现在 _source 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;firstname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;copy_to&quot;: &quot;fullName&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;lastname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;copy_to&quot;: &quot;fullName&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET users&#x2F;_search?q&#x3D;fullName:(Ruan Yiming)</span><br></pre></td></tr></table></figure>

<h4 id="多字段"><a href="#多字段" class="headerlink" title="多字段"></a>多字段</h4><p>可以给 Text 字段增加 keyword 字段以实现精确匹配（默认），还可以为字段的搜索和索引指定不同的 analyzer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;company&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                    &quot;keyword&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                        &quot;ignore_above&quot;: 256</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;comment&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                &quot;fields&quot;: &#123;</span><br><span class="line">                    &quot;english_comment&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                        &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class="line">                        &quot;search_analyzer&quot;: &quot;english&quot;,</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新-Mapping"><a href="#更新-Mapping" class="headerlink" title="更新 Mapping"></a>更新 Mapping</h2><ul>
<li><p>新增字段</p>
<ul>
<li>dynamic 为 true：一旦有新增字段的文档写入，Mapping 也同时被更新。</li>
<li>dynamic 为 false：Mapping 不会被更新，新增字段的数据无法被索引，但是信息会出现在 _source 中</li>
<li>dynamic 为 strict：文档写入失败</li>
</ul>
</li>
<li><p>已有字段：一旦已经有数据写入，就不再支持修改字段定义</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/Elasticsearch%E5%88%86%E8%AF%8D%E4%B8%8E%E5%88%86%E8%AF%8D%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/Elasticsearch%E5%88%86%E8%AF%8D%E4%B8%8E%E5%88%86%E8%AF%8D%E5%99%A8/" class="post-title-link" itemprop="url">Elasticsearch 分词与分词器</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-11 17:08:00" itemprop="dateCreated datePublished" datetime="2020-02-11T17:08:00+08:00">2020-02-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-21 11:25:16" itemprop="dateModified" datetime="2020-02-21T11:25:16+08:00">2020-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>分词（Analysis）是把全文本转换成一系列单词（term/token）的过程。<br>分词是通过分词器（Analyzer）来实现的。我们可以使用 ELasticsearch 内置的分词器，也可以按需定制化分词器。<br><strong>除了在数据写入时转换词条，匹配 Query 语句时也需要用相同的分词器对查询语句进行分析。</strong></p>
<h2 id="分词器组成"><a href="#分词器组成" class="headerlink" title="分词器组成"></a>分词器组成</h2><p>分词器由三部分组成：</p>
<ul>
<li>Character Filters：针对原始文本处理，例如去除 html</li>
<li>Tokenizer：按照规则切分为单词</li>
<li>Token Filter：将切分的单词进行加工：小写、删除 stopwords、增加同义词..</li>
</ul>
<p><img src="images/elasticsearch/%E5%88%86%E8%AF%8D%E5%99%A8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B.png" alt="分词器处理流程示例"></p>
<h2 id="Elasticsearch-内置分词器"><a href="#Elasticsearch-内置分词器" class="headerlink" title="Elasticsearch 内置分词器"></a>Elasticsearch 内置分词器</h2><ul>
<li>Standard Analyzer：默认分词器，按词切分，小写处理</li>
<li>Simple Analyzer：按照非字母切分（符号被过滤），小写处理</li>
<li>Stop Analyzer：停用词过滤（the, a, is），小写处理</li>
<li>Whitespace Analyzer：按照空格切分，不转小写</li>
<li>Keyword Analyzer：正则表达式，默认 \W+（非字符分割）</li>
<li>Language：提供了30多种常见语言的分词器</li>
<li>Customer Analyzer：自定义分词器</li>
</ul>
<h2 id="中文分词"><a href="#中文分词" class="headerlink" title="中文分词"></a>中文分词</h2><p>中文分词有它特定的一些难点：</p>
<ul>
<li>中文句子，切分成一个一个词，而不是一个个字。（英文中，单词有自然的空格作为分割）</li>
<li>一句中文，在不同的上下文中，有不同的理解。（eg: 这个苹果，不大好吃/这个苹果，不大，好吃）</li>
</ul>
<p>中文分词器：</p>
<ul>
<li>IK</li>
<li>THULAC</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/Elasticsearch%E5%B8%B8%E7%94%A8API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/Elasticsearch%E5%B8%B8%E7%94%A8API/" class="post-title-link" itemprop="url">Elasticsearch 常用 API</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-11 17:08:00" itemprop="dateCreated datePublished" datetime="2020-02-11T17:08:00+08:00">2020-02-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-21 11:25:32" itemprop="dateModified" datetime="2020-02-21T11:25:32+08:00">2020-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h2><h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><p>如果 id 不存在，创建新的文档。否则，先删除现有的文档，再创建新的文档，版本号加 1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index&#x2F;_doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;mike&quot;,</span><br><span class="line">    &quot;comment&quot;: &quot;You konw, for search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><ul>
<li>自动创建 id</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST my_index&#x2F;_doc</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;mike&quot;,</span><br><span class="line">    &quot;comment&quot;: &quot;You konw, for search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定 id（如果 id 已经存在，会失败）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index&#x2F;_create&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot;: &quot;mike&quot;,</span><br><span class="line">    &quot;comment&quot;: &quot;You konw, for search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p>文档必须已经存在，更新只会对相应字段做增量修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST my_index&#x2F;_update&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;user&quot;: &quot;mike&quot;,</span><br><span class="line">        &quot;comment&quot;: &quot;You konw, for search&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>找到文档，返回 HTTP 200，否则返回 HTTP 404</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET my_index&#x2F;_doc&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p>删除文档。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index&#x2F;_doc&#x2F;1</span><br></pre></td></tr></table></figure>

<h3 id="bulk"><a href="#bulk" class="headerlink" title="bulk"></a>bulk</h3><ul>
<li>支持在一次 API 调用中，对不同的索引进行操作</li>
<li>支持 index、create、update、delete 四种操作类型</li>
<li>可以在 URI 中指定 index，也可以在请求的 payload 中进行</li>
<li>操作中单条操作失败，并不会影响其它操作</li>
<li>返回结果中包括了每一条操作执行的结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123;&quot;index&quot;: &#123;&quot;_index&quot;: &quot;test&quot;, &quot;_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;field1&quot;: &quot;value1&quot;&#125;</span><br><span class="line">&#123;&quot;delete&quot;: &#123;&quot;_index&quot;: &quot;test&quot;, &quot;_id&quot;: &quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;create&quot;: &#123;&quot;_index&quot;: &quot;test2&quot;, &quot;_id&quot;: &quot;3&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;field1&quot;: &quot;value3&quot;&#125;</span><br><span class="line">&#123;&quot;update&quot;: &#123;&quot;_index&quot;: &quot;test&quot;, &quot;_id&quot;: &quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;: &#123;&quot;field2&quot;: &quot;value2&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mget"><a href="#mget" class="headerlink" title="mget"></a>mget</h3><p>批量操作，可以减少网路连接所产生的开销，提高性能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET _mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot;: &quot;user,</span><br><span class="line">            &quot;_id&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;_index&quot;: &quot;comment,</span><br><span class="line">            &quot;_id&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="msearch"><a href="#msearch" class="headerlink" title="msearch"></a>msearch</h3><p>批量查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST users&#x2F;_msearch</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#123;&quot;query&quot;: &#123;&quot;match_all&quot; : &#123;&#125;&#125;, &quot;from&quot;: 0, size&quot;: 10&#125;</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#123;&quot;query&quot;: &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</span><br><span class="line">&#123;&quot;index&quot;: &quot;twitter2&quot;&#125;</span><br><span class="line">&#123;&quot;query&quot;: &#123;&quot;match_all&quot; : &#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">范围</th>
</tr>
</thead>
<tbody><tr>
<td align="center">/_search</td>
<td align="center">集群上所有的索引</td>
</tr>
<tr>
<td align="center">/index1/_search</td>
<td align="center">index1</td>
</tr>
<tr>
<td align="center">/index1,index2/_search</td>
<td align="center">index1 和 index2</td>
</tr>
<tr>
<td align="center">/index*/_search</td>
<td align="center">以 index 开头的索引</td>
</tr>
</tbody></table>
<h3 id="URI-Search"><a href="#URI-Search" class="headerlink" title="URI Search"></a>URI Search</h3><p>在 URL 中使用查询参数。</p>
<ul>
<li>q：指定查询语句，使用 Query String Syntax，KV 键值对</li>
<li>df：默认字段，不指定时，会对所有字段进行查询</li>
<li>sort：排序</li>
<li>from/size：用于分页</li>
<li>profile：查看查询是如何被执行的</li>
</ul>
<p>eg:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;movies&#x2F;_search?q&#x3D;2012&amp;df&#x3D;title&amp;sort&#x3D;tear:desc&amp;from&#x3D;0&amp;size&#x3D;10&amp;timeout&#x3D;1s</span><br><span class="line">&#123;</span><br><span class="line">    &quot;profile&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="指定字段-vs-范查询"><a href="#指定字段-vs-范查询" class="headerlink" title="指定字段 vs 范查询"></a>指定字段 vs 范查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q&#x3D;title:2012 &#x2F; q&#x3D;2012</span><br></pre></td></tr></table></figure>

<h4 id="Term-vs-Phrase"><a href="#Term-vs-Phrase" class="headerlink" title="Term vs Phrase"></a>Term vs Phrase</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Beautiful Mind &#x3D;&gt; Beautiful OR Mind</span><br><span class="line">&quot;Beautiful Mind&quot; &#x3D;&gt; Beautiful AND Mind (Phrase Query)</span><br></pre></td></tr></table></figure>

<h4 id="分组与引号"><a href="#分组与引号" class="headerlink" title="分组与引号"></a>分组与引号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">title: (Beautiful Mind) (Term Query)</span><br><span class="line"></span><br><span class="line">title: &quot;Beautiful Mind&quot; (Phrase Query)</span><br></pre></td></tr></table></figure>

<h4 id="布尔操作"><a href="#布尔操作" class="headerlink" title="布尔操作"></a>布尔操作</h4><p>AND / OR /NOT （必须大写）或者 &amp;&amp; / || / !</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title:(matrix NOT reloaded)</span><br></pre></td></tr></table></figure>

<h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><ul>
<li>=&gt; must</li>
</ul>
<ul>
<li>=&gt; must_not</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title:(+matrix -reloaded)</span><br></pre></td></tr></table></figure>

<h4 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h4><p>[] =&gt; 闭区间<br>{} =&gt; 开区间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">year:&#123;2019 TO 2018]</span><br><span class="line">year:[* TO 2018]</span><br></pre></td></tr></table></figure>

<h4 id="算数符号"><a href="#算数符号" class="headerlink" title="算数符号"></a>算数符号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">year:&gt;2010</span><br><span class="line">year:(&gt;2010 &amp;&amp; &lt;&#x3D; 2018)</span><br><span class="line">year:(+&gt;2010 +&lt;&#x3D; 2018)</span><br></pre></td></tr></table></figure>

<ul>
<li>通配符查询<br>? =&gt; 1 个字符</li>
<li>0 或多个字符</li>
</ul>
<p>通配符查询效率低，占用内存大，不建议使用。特别是放在最前面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">title:mi?d</span><br><span class="line">title:be*</span><br></pre></td></tr></table></figure>

<h4 id="正则表达"><a href="#正则表达" class="headerlink" title="正则表达"></a>正则表达</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title:[bt]oy</span><br></pre></td></tr></table></figure>

<h4 id="模糊匹配与近似查询"><a href="#模糊匹配与近似查询" class="headerlink" title="模糊匹配与近似查询"></a>模糊匹配与近似查询</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">title:befutifl~1</span><br><span class="line">title:&quot;lord rings&quot;~2</span><br></pre></td></tr></table></figure>

<h3 id="Request-Body-Search"><a href="#Request-Body-Search" class="headerlink" title="Request Body Search"></a>Request Body Search</h3><p>使用 Elasticsearch 提供的，基于 JSON 格式的更加完备的 DSL。</p>
<p>eg:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>from 从 0 开始，默认返回 10 个结果。获取靠后的翻页成本较高。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;from&quot;: 10,</span><br><span class="line">    ”size&quot;: 5,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>最好在“数字型”与“日期型”字段上排序，因为对于多值类型或分析过的字段排序，系统会选一个值，无法得知该值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;sort&quot;: [&#123;&quot;order_date&quot;: &quot;desc&#125;],</span><br><span class="line">    &quot;from&quot;: 10,</span><br><span class="line">    ”size&quot;: 5,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="source-filtering"><a href="#source-filtering" class="headerlink" title="_source filtering"></a>_source filtering</h4><p>如果 _source 没有存储，那就只返回匹配的文档的元数据。_source 支持使用通配符，如 _source[“name*”,”desc*”]。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: [&quot;order_date&quot;, &quot;category.keyword&quot;],</span><br><span class="line">    &quot;from&quot;: 10,</span><br><span class="line">    ”size&quot;: 5,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="match"><a href="#match" class="headerlink" title="match"></a>match</h4><p>默认 OR 查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;comments&#x2F;_doc&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">            &quot;comment&quot;: &quot;Last Christmas&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AND 查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;comments&#x2F;_doc&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">            &quot;comment&quot;: &quot;Last Christmas&quot;,</span><br><span class="line">            &quot;operator&quot;: &quot;AND&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="match-phrase"><a href="#match-phrase" class="headerlink" title="match_phrase"></a>match_phrase</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;comments&#x2F;_doc&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_phrase&quot;: &#123;</span><br><span class="line">            &quot;comment&quot;: &quot;Song Last Chrismas&quot;,</span><br><span class="line">            &quot;slop&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="query-string"><a href="#query-string" class="headerlink" title="query_string"></a>query_string</h4><p>单字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;users&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot;: &#123;</span><br><span class="line">            &quot;default_field&quot;: &quot;name&quot;,</span><br><span class="line">            &quot;query&quot;: &quot;Ruan AND Yiming&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;users&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;query_string&quot;: &#123;</span><br><span class="line">            &quot;fields&quot;: [&quot;name&quot;, &quot;about&quot;],</span><br><span class="line">            &quot;query&quot;: &quot;(Ruan AND Yiming) OR (Java AND Elasticsearch)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="simple-query-string"><a href="#simple-query-string" class="headerlink" title="simple_query_string"></a>simple_query_string</h4><p>类似 query_string，但是会忽略错误的语法，同时只支持部分查询语法；不支持 AND OR NOT，会当作字符串处理；Term 之间默认的关系是 OR，可以指定 Operator；支持部分逻辑：+ 替代 AND，| 替代 OR，- 替代 NOT。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;users&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;simple_query_string&quot;: &#123;</span><br><span class="line">            &quot;fields&quot;: [&quot;name&quot;],</span><br><span class="line">            &quot;query&quot;: &quot;Ruan -Yiming&quot;,</span><br><span class="line">            &quot;default_operator&quot;: &quot;AND&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Aggregation"><a href="#Aggregation" class="headerlink" title="Aggregation"></a>Aggregation</h2><h3 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;flight_dest&quot;: &#123;</span><br><span class="line">            &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;DestCountry&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Metric"><a href="#Metric" class="headerlink" title="Metric"></a>Metric</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;flight_dest&quot;: &#123;</span><br><span class="line">            &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;DestCountry&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;average_price&quot;: &#123;</span><br><span class="line">                    &quot;avg&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;AbgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;max_price&quot;: &#123;</span><br><span class="line">                    &quot;max&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;AbgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;min_price&quot;: &#123;</span><br><span class="line">                    &quot;min&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;AbgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nested"><a href="#Nested" class="headerlink" title="Nested"></a>Nested</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_flights&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;flight_dest&quot;: &#123;</span><br><span class="line">            &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;DestCountry&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;average_price&quot;: &#123;</span><br><span class="line">                    &quot;avg&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;AbgTicketPrice&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;weather&quot;: &#123;</span><br><span class="line">                    &quot;terms&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: DestWeather</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h2><ul>
<li><p>查看 Mapping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET users&#x2F;_mapping</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 Mapping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT users</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;firstname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;lastname&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;text&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Analyzer"><a href="#Analyzer" class="headerlink" title="Analyzer"></a>Analyzer</h2><h3 id="analyze"><a href="#analyze" class="headerlink" title="analyze"></a>analyze</h3><ul>
<li>指定 Analyzer 进行测试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;2 running Quik brown-foxes leap over lazy dogs in the summer evening.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>指定索引的字段进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST books&#x2F;_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;field&quot;: &quot;title&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;Mastering Elasticsearch&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义分词器进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;tokenizer&quot;: &quot;standard&quot;,</span><br><span class="line">    &quot;filter&quot;: [&quot;lowercase&quot;],</span><br><span class="line">    &quot;text&quot;: &quot;Mastering Elasticsearch&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><h3 id="Index-Template"><a href="#Index-Template" class="headerlink" title="Index Template"></a>Index Template</h3><p>Index Template 可以帮助我们设置 Mappings 和 Settings，并按照一定的规则，自动匹配到新创建的索引之上。</p>
<ul>
<li>模板仅在一个索引被创建时，才会产生作用。修改模板不会影响已创建的索引。</li>
<li>可以设定多个索引模板，这些设置会被“merge”在一起。</li>
<li>可以指定“order”的数值，控制“merging”的过程。（由低到高）</li>
<li>应用创建索引时，用户所指定的 Settings 和 Mappings，会覆盖之前模板中的设定。</li>
</ul>
<p><strong>设置 Template</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;_template&#x2F;template_test</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index_patterns&quot;: [&quot;test*&quot;],</span><br><span class="line">    &quot;order&quot;: 1,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;number_of_shards&quot;: 1,</span><br><span class="line">        &quot;number_of_replicas&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;date_detection&quot;: false,</span><br><span class="line">        &quot;numeric_detection&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 查看 Template：**</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_template&#x2F;template_default</span><br><span class="line"></span><br><span class="line">GET &#x2F;_template&#x2F;temp*</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-Template"><a href="#Dynamic-Template" class="headerlink" title="Dynamic Template"></a>Dynamic Template</h3><p>根据 Elasticsearch 识别的数据类型，结合字段名称，来动态设定字段类型。</p>
<ul>
<li>Dynamic Template 是定义在某个索引的 Mapping 中</li>
<li>Template 有一个名称</li>
<li>匹配规则是一个数组</li>
<li>为匹配到字段设置 Mapping</li>
</ul>
<p>比如我们可以：</p>
<ul>
<li>所有的字符串类型都设定为 keyword，或者关闭 keyword</li>
<li>is 开头的字段都设置成 boolean</li>
<li>long_开头的都设置成 long 类型</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT my_text_index</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;dynamic_templates&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;full_name&quot;: &#123;</span><br><span class="line">                    &quot;path_match&quot;: &quot;name.*&quot;,</span><br><span class="line">                    &quot;path_unmatch&quot;: &quot;*.middle&quot;,</span><br><span class="line">                    &quot;mapping&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                        &quot;copy_to&quot;: &quot;full_name&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;string_as_boolean&quot;: &#123;</span><br><span class="line">                    &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">                    &quot;match&quot;: &quot;is*&quot;,</span><br><span class="line">                    &quot;mapping&quot;: &#123;</span><br><span class="line">                        &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/Elasticsearch%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/Elasticsearch%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">Elasticsearch集群架构</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-11 16:20:17 / 修改时间：16:51:23" itemprop="dateCreated datePublished" datetime="2020-02-11T16:20:17+08:00">2020-02-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>title:Elasticsearch 集群架构<br>date:2020-02-1116:20:00<br>categories:Elasticsearch</p>
<hr>
<h2 id="主要特征"><a href="#主要特征" class="headerlink" title="主要特征"></a>主要特征</h2><p>从架构的角度出发，ElasticSearch 具有下面这些主要特征：</p>
<ul>
<li><p>合理的默认配置，使得用户在简单安装以后能直接使用 ElasticSearch 而不需要任何额外的调试，这包括内置的发现（如字段类型检测）和自动配置功能。</p>
</li>
<li><p>默认的分布式工作模式，每个节点总是假定自己是某个集群的一部分或将是某个集群的一部分，一旦工作启动节点便会加入某个集群。</p>
</li>
<li><p>对等架构（P2P）可以避免单点故障（SPOF），节点会自动连接到集群中的其他节点，进行相互的数据交换和监控操作。这其中就包括索引分片的自动复制。</p>
</li>
<li><p>易于向集群扩充新节点，不论是从数据容量的角度还是数量角度。</p>
</li>
<li><p>ElasticSearch 没有对索引中的数据结构强加任何限制，从而允许用户调整现有的数据模型。正如之前描述的那样，ElasticSearch 支持在一个索引中存在多种数据类型，并允许用户调整业务模型，包括处理文档之间的关联（尽管这种功能非常有限）。</p>
</li>
<li><p>准实时（NearRealTime，NRT）搜索和版本同步（versioning）。考虑到 ElasticSearch 的分布式特性，查询延迟和节点之间临时的数据不同步是难以避免的。ElasticSearch 尝试消除这些问题并且提供额外的机制用于版本同步。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/Elasticsearch%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/Elasticsearch%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">Elasticsearch 基本概念</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-11 11:34:00 / 修改时间：16:10:07" itemprop="dateCreated datePublished" datetime="2020-02-11T11:34:00+08:00">2020-02-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Elasticsearch 是一 个基于 Lucene 构建的开源、分布式、RESTful 接口的全文搜索引擎。</p>
<h2 id="Lucense"><a href="#Lucense" class="headerlink" title="Lucense"></a>Lucense</h2><p>Lucene 是 Apache 软件基金会中一个开放源代码的全文搜索引擎工具包，是一个全文搜索引擎的架构，提供了完整的查询引擎和索引引擎，部分文本分析引擎。Lucene 的目的是为软件开发人员提供一个简单易用的工具包，以方便在目标系统中实现全文检索的功能，或者是以此为基础建立起完整的全文搜索引擎。</p>
<h2 id="全文搜索（Full-Text-Search）"><a href="#全文搜索（Full-Text-Search）" class="headerlink" title="全文搜索（Full Text Search）"></a>全文搜索（Full Text Search）</h2><p>全文搜索是指计算机搜索程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，搜索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户。这个过程类似于通过字典中的搜索字表查字的过程。</p>
<h2 id="倒排索引（Inverted-Index）"><a href="#倒排索引（Inverted-Index）" class="headerlink" title="倒排索引（Inverted Index）"></a>倒排索引（Inverted Index）</h2><p>倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。<strong>由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引（invertedindex）</strong>。带有倒排索引的文件我们称为倒排索引文件，简称倒排文件（invertedfile）。</p>
<p>倒排索引包含两个部分：</p>
<ul>
<li>单词字典（Term Dictionary）：记录所有文档的单词，记录单词到倒排列表的关联关系。（单词字典一般比较大，可以通过 B+ 树或哈希链表法实现，以满足高性能的插入与查询）</li>
<li>倒排列表（Posting List）：记录了单词对应的文档结合，由倒排索引项组成：<ul>
<li>文档 ID</li>
<li>词频 TF：该词在文档中出现的次数，用于相关性评分。</li>
<li>位置（Position）：单词在文档中分词的位置。用于语句搜索（phrase query）。</li>
<li>偏移（Offset）：记录单词的开始结束位置，实现高亮显示。</li>
</ul>
</li>
</ul>
<h2 id="文档（Document）"><a href="#文档（Document）" class="headerlink" title="文档（Document）"></a>文档（Document）</h2><p>Elasticsearch 是面向文档的，文档是所有可搜索数据的最小单位；文档会被序列化成 JSON 格式，其中每个字段都有对应的字段类型（字符串/数值/布尔/日期/二进制/范围类型）；每个文档都有一个 Unique ID，我们可以自己指定 ID，也可以通过 Elasticsearch 自动生成。</p>
<p><strong>文档元数据：</strong></p>
<ul>
<li>_index：文档所属的索引名</li>
<li>_type：文档所属的类型名</li>
<li>_id：文档唯一 ID</li>
<li>_source：文档的原始 Json 数据</li>
<li>_all：整合所有字段内容到该字段，已被废除</li>
<li>_version：文档的版本信息</li>
<li>_score：相关性打分</li>
</ul>
<h2 id="索引（Index）"><a href="#索引（Index）" class="headerlink" title="索引（Index）"></a>索引（Index）</h2><p>索引是具有相同结构的文档集合。它体现了逻辑空间的概念：每个索引都有自己的 Mapping 定义，用于定义包含的文档的字段名和字段类型。我们可以在 Index 上定义 Mapping（文档字段的类型）和 Setting（不同的数据分布）。</p>
<h2 id="类型（Type）"><a href="#类型（Type）" class="headerlink" title="类型（Type）"></a>类型（Type）</h2><p>类型是索引的逻辑分区。在 7.0 之前，一个 Index 可以设置多个 Types。<strong>从 7.0 开始，每个索引做能创建一个类型：_doc。</strong></p>
<h2 id="映射（Mapping）"><a href="#映射（Mapping）" class="headerlink" title="映射（Mapping）"></a>映射（Mapping）</h2><p>映射定义了索引中的每一个字段类型，以及一个索引范围内的设置。一个映射可以事先被定义，或者在第一次存储文档的时候自动识别。</p>
<h2 id="集群（Cluster）"><a href="#集群（Cluster）" class="headerlink" title="集群（Cluster）"></a>集群（Cluster）</h2><p>集群由一个或多个节点组成，对外提供服务。<strong>一个集群有一个唯一的名称默认为 Elasticsearch</strong>。此名称是很重要的，因为每个节点只能是集群的一部分，<strong>当该节点被设置为相同的集群名称时，就会自动加入集群</strong>。当需要有多个集群的时候，要确保每个集群的名称不能重复，否则，节点可能会加入错误的集群。请注意，<strong>一个节点只能加入一个集群</strong>。此外，我们还可以拥有多个独立的集群，每个集群都有其不同的集群名称。</p>
<h2 id="节点（Node）"><a href="#节点（Node）" class="headerlink" title="节点（Node）"></a>节点（Node）</h2><p>单个的 ElasticSearch 服务实例称为节点（node）。很多时候部署一个 ElasticSearch 节点就足以应付大多数简单的应用，但是考虑到容错性或在数据膨胀到单机无法应付这些状况时，我们会更倾向于使用多节点的 ElasticSearch 集群。</p>
<p><strong>节点类型：</strong><br>节点类型 | 说明 | 配置参数 | 默认值<br>:-: | :-: | :-: | :-:<br>master eligible | 可以参加选主流程，成为 Master 节点 | node.master | true<br>data | 保存分片数据 | node.data | true<br>ingest | 执行预处理管道，不负责数据也不负责集群相关的事务 | node.ingest | true<br>coordination only | 接受 Client 请求，将请求分发到合适的节点，最终把结果汇集到一起 | 无 | 每个节点默认都是 coordination 节点。设置其它类型全部为 false。<br>machine learning | 执行机器学习的 Job，用来做异常检测 | node.ml | true （需 enable x-pack）</p>
<p>在开发环境中，一个节点可以承担多种角色；在生产环境中，应该设置单一的角色节点（dedicated node）。</p>
<h2 id="主分片（Primary-Shard）"><a href="#主分片（Primary-Shard）" class="headerlink" title="主分片（Primary Shard）"></a>主分片（Primary Shard）</h2><p>用以解决数据水平扩展的问题。通过主分片，可以将数据分布到集群内的所有节点之上。主分片数在索引创建时指定，后续不允许修改，除非 Reindex。</p>
<p><strong>对于生产环境中分片的设定，需要提前做好容量规划：</strong></p>
<ul>
<li>分片数设置过小：导致后续无法增加节点实现水平扩展；单个分片的数据量太大，导致重新分配耗时。</li>
<li>分片数设置过大：影响搜索结果的相关性打分，影响统计结果的准确性；单个节点上过多的分片，会导致资源浪费，同时也会影响性能。</li>
</ul>
<h2 id="副本分片（Replica-Shard）"><a href="#副本分片（Replica-Shard）" class="headerlink" title="副本分片（Replica Shard）"></a>副本分片（Replica Shard）</h2><p>用以解决数据高可用的问题。副本分片是主分片的拷贝。副本分片数可以动态地调整。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/%E5%9F%BA%E4%BA%8EDocker%E6%90%AD%E5%BB%BAElasticsearch%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/11/%E5%9F%BA%E4%BA%8EDocker%E6%90%AD%E5%BB%BAElasticsearch%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">基于 Docker 搭建 Elasticsearch 集群</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-11 11:10:00 / 修改时间：11:13:22" itemprop="dateCreated datePublished" datetime="2020-02-11T11:10:00+08:00">2020-02-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">Elasticsearch</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>创建 network</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --subnet 172.22.0.0/16 --gateway 172.22.0.1  op_net</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 elasticsearch.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.6'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">cerebro:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lmenezes/cerebro</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cerebro</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9000</span><span class="string">:9000</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-Dhosts.0.host=http://elasticsearch:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.22</span><span class="number">.0</span><span class="number">.24</span></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">I18N_LOCALE=zh-CN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TIMELION_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">XPACK_GRAPH_ENABLED=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">XPACK_MONITORING_COLLECTION_ENABLED="true"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5601</span><span class="string">:5601</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.22</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es_hot</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es_hot</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.attr.box_type=hot</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es_hot,es_warm,es_cold</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es_hot,es_warm,es_cold</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es_data_hot:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.22</span><span class="number">.0</span><span class="number">.21</span></span><br><span class="line">  <span class="attr">elasticsearch2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es_warm</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es_warm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.attr.box_type=warm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es_hot,es_warm,es_cold</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es_hot,es_warm,es_cold</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es_data_warm:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.22</span><span class="number">.0</span><span class="number">.22</span></span><br><span class="line">  <span class="attr">elasticsearch3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es_cold</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es_cold</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.attr.box_type=cold</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es_hot,es_warm,es_cold</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es_hot,es_warm,es_cold</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es_data_cold:/usr/share/elasticsearch/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">ipv4_address:</span> <span class="number">172.22</span><span class="number">.0</span><span class="number">.23</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">es_data_hot:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">es_data_warm:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">es_data_cold:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">op_net</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Elasticsearch 集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f elasticsearch.yml up -d</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/08/Netty%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/08/Netty%E5%BF%83%E8%B7%B3%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Netty心跳机制</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-08 14:52:00 / 修改时间：20:41:41" itemprop="dateCreated datePublished" datetime="2020-02-08T14:52:00+08:00">2020-02-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="何为心跳"><a href="#何为心跳" class="headerlink" title="何为心跳"></a>何为心跳</h2><p>顾名思义，所谓心跳，即在 TCP 长连接中，客户端和服务器之间定期发送的一种特殊的数据包，通知对方自己还在线，以确保 TCP 连接的有效性。</p>
<h2 id="为什么需要心跳"><a href="#为什么需要心跳" class="headerlink" title="为什么需要心跳"></a>为什么需要心跳</h2><p>因为网络的不可靠性，有可能在 TCP 保持长连接的过程中，由于某些突发情况，例如网线被拔出，突然掉电等，会造成服务器和客户端的连接中断。<br>在这些突发情况下，如果恰好服务器和客户端之间没有交互的话，那么它们是不能在短时间内发现对方已经掉线的。<br>为了解决这个问题，我们就需要引入心跳机制。<br>心跳机制的工作原理是：在服务器和客户端之间一定时间内没有数据交互时，即处于 idle 状态时，客户端或服务器会发送一个特殊的数据包给对方，当接收方收到这个数据报文之后，也立即发送一个特殊的数据报文，回应发送方，此即一个 PING-PONMG 交互。自然地，当某一端收到心跳消息后，就知道了对方仍然在线，这就确保 TCP 连接的有效性。</p>
<h2 id="如何实现心跳"><a href="#如何实现心跳" class="headerlink" title="如何实现心跳"></a>如何实现心跳</h2><p>我们可以通过两种方式实现心跳机制：</p>
<ul>
<li>使用 TCP 协议层里面的 keepalive 机制</li>
<li>在应用层上实现自定义的心跳机制（在 Netty 中即为 Idle check）</li>
</ul>
<p>虽然在 TCP 协议层上，提供了 keepalive 保活机制，但是使用它有几个缺点：</p>
<ol>
<li>它不是 TCP 的标准协议，并且默认时关闭的。</li>
<li>TCP keepalive 机制依赖于操作系统的实现，默认的 keepalive 心跳时间是<strong>两个小时</strong>，并且对 keepalive 的修改需要系统调用（或者修改系统配置），灵活性不够。</li>
<li>TCP keepalive 与 TCP 协议绑定，因此如果需要更换为 UDP 协议时，keepalive 机制就失效了。</li>
</ol>
<p>虽然使用 TCP 层面的 keepalive 机制比自定义的应用层心跳机制节省流量, 但是基于上面的几点缺点, 一般的实践中, 人们大多数都是选择在应用层上实现自定义的心跳。</p>
<h3 id="TCP-keepalive"><a href="#TCP-keepalive" class="headerlink" title="TCP keepalive"></a>TCP keepalive</h3><p>TCP keepalive 核心参数：</p>
<ul>
<li>net.ipv4.tcp_keepalive_time = 7200</li>
<li>net.ipv4.tcp_keepalive_intl = 75</li>
<li>net.ipv4.tcp_keepalive_probes = 9<br>当启用（默认关闭）keepalive 时，TCP 在连接没有数据通过的 7200 秒后发送 keepalive 消息，当探测没有回复时按 75 秒的重试频率重发，一直发 9 个探测包都没有确认时连接失败，所以总耗时一般为：2 小时 11 分（7200 秒 + 75 * 9）。</li>
</ul>
<h3 id="Idle-check"><a href="#Idle-check" class="headerlink" title="Idle check"></a>Idle check</h3><p>Idle 监测，只是负责诊断，诊断后，做出不同的行为，决定 Idle 监测的最终用途。</p>
<ul>
<li>发送 keepalive（区别于 TCP keepalive）：在有其它数据传输的时候，不发送 keepalive，无数据传输超过一定时间，判定为 Idle，再发 keepalive。</li>
<li>直接关闭连接：快速释放损坏的、恶意的、很久不用的连接，让系统时刻保持最好的状态；简单粗暴，客户端可能需要重连。<br>实际应用中：结合起来使用。按需 keepalive，保证不会空闲，如果空闲，关闭连接。</li>
</ul>
<h2 id="Netty-中开启心跳监测"><a href="#Netty-中开启心跳监测" class="headerlink" title="Netty 中开启心跳监测"></a>Netty 中开启心跳监测</h2><h3 id="Server-端开启-TCP-keepalive"><a href="#Server-端开启-TCP-keepalive" class="headerlink" title="Server 端开启 TCP keepalive"></a>Server 端开启 TCP keepalive</h3><ul>
<li>bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true)</li>
<li>bootstrap.childOption(NioChannelOption.SO_KEEPALIVE, true)</li>
</ul>
<p>注意，是 <strong>.childOption</strong>(ChannelOption.SO_KEEPALIVE, true) 而不是 .option(ChannelOption.SO_KEEPALIVE, true)，虽然可以设置后者，但是无效。</p>
<h3 id="开启-Idle-Check"><a href="#开启-Idle-Check" class="headerlink" title="开启 Idle Check"></a>开启 Idle Check</h3><p>要开启 Idle Check，关键是继承 <strong>IdleStateHandler</strong>。实例化一个 IdleStateHandler 需要提供 3 个参数：</p>
<ul>
<li>readerIdleTimeSeconds：读超时. 即当在指定的时间间隔内没有从 Channel 读取到数据时, 会触发一个 READER_IDLE 的 IdleStateEvent 事件。</li>
<li>writerIdleTimeSeconds：写超时. 即当在指定的时间间隔内没有数据写入到 Channel 时, 会触发一个 WRITER_IDLE 的 IdleStateEvent 事件。</li>
<li>allIdleTimeSeconds：读/写超时. 即当在指定的时间间隔内没有读或写操作时, 会触发一个 ALL_IDLE 的 IdleStateEvent 事件。</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://segmentfault.com/a/1190000006931568" target="_blank" rel="noopener">浅析 Netty 实现心跳机制与断线重连</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/08/Netty%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/08/Netty%E5%BA%8F%E5%88%97%E5%8C%96%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-title-link" itemprop="url">Netty 序列化/反序列化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-02-08 13:20:00 / 修改时间：13:49:32" itemprop="dateCreated datePublished" datetime="2020-02-08T13:20:00+08:00">2020-02-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="为什么需要二次编解码"><a href="#为什么需要二次编解码" class="headerlink" title="为什么需要二次编解码"></a>为什么需要二次编解码</h2><p>假设我们把解决粘包半包问题的常用三种解码器叫做一次解码器，那么我们在项目中，除了可选的压缩解压缩之外，还需要一层解码，因为一次解码的结果是字节，需要和项目中所使用的对象做转换，方便使用，这层解码器可以成为“二次解码器”，相应的，对应的编码器是为了将 Java 对象转化成字节流方便存储或传输。</p>
<ul>
<li><p>一次解码器：ByteToMessageDecoder<br>io.netty.buffer.ByteBuf（原始数据流） -&gt; io.netty.buffer.ByteBuf（用户数据）</p>
</li>
<li><p>二次解码器：MessageToMessageDecoder<I><br>io.netty.buffer.ByteBuf（用户数据） -&gt; Java Object</p>
</li>
</ul>
<h2 id="常用二次编码码方式"><a href="#常用二次编码码方式" class="headerlink" title="常用二次编码码方式"></a>常用二次编码码方式</h2><ul>
<li>Java序列化：基本已经没人使用，因为它占用的空间比较大，且只有在 Java 中能够使用</li>
<li>Marshaling</li>
<li>XML：占用空间比较大</li>
<li>JSON</li>
<li>MessagePack</li>
<li>ProtoBuf：灵活的、高效的用于序列化数据的协议；相较于 XML 和 JSON 格式，Protobuf 更小、更快、更便捷；Protobuf 是跨语言的，并且自带了一个编译器（protoc），只需要用它进行编译，可以自动生成 Java、Python、C++ 等代码，不需要再写其它代码。</li>
<li>其它</li>
</ul>
<h2 id="编解码方式选择依据"><a href="#编解码方式选择依据" class="headerlink" title="编解码方式选择依据"></a>编解码方式选择依据</h2><ul>
<li>空间：编码后占用空间，需要比较不同的数据大小情况</li>
<li>时间：编解码速度，需要比较不同的数据大小情况</li>
<li>可读性</li>
<li>多语言的支持：重要</li>
</ul>
<h2 id="Netty-对常用编解码方式的支持"><a href="#Netty-对常用编解码方式的支持" class="headerlink" title="Netty 对常用编解码方式的支持"></a>Netty 对常用编解码方式的支持</h2><ol>
<li>相关类都在包 io.netty.handler.codec</li>
<li>支持 base64、bytes、compression、json、marshaling、protobuf、serialization、string、xml等</li>
<li>编码器继承自 MessageToMessageEncoder<I>，解码器继承自 MessageToMessageDecoder<I></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/07/Netty%E7%B2%98%E5%8C%85%E5%8D%8A%E5%8C%85%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/07/Netty%E7%B2%98%E5%8C%85%E5%8D%8A%E5%8C%85%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">Netty 粘贴/半包处理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-07 22:20:00" itemprop="dateCreated datePublished" datetime="2020-02-07T22:20:00+08:00">2020-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-08 13:15:38" itemprop="dateModified" datetime="2020-02-08T13:15:38+08:00">2020-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="什么是粘包-半包"><a href="#什么是粘包-半包" class="headerlink" title="什么是粘包/半包"></a>什么是粘包/半包</h2><p>比如客户端向服务器端发送了两条消息，分别是“ABC”、“DEF”，由于 TCP 是流式协议，服务器端可能会一次性接收到这两条消息“ABCDEF”，也可能会分 3、4次才接收到这两条消息，如分 3 次分别接收“AB”、“CD”、“EF”，前面一次性接收就是<strong>粘包</strong>，后面分 3、4 接收就是<strong>半包</strong>。</p>
<h2 id="粘包-半包主要原因"><a href="#粘包-半包主要原因" class="headerlink" title="粘包/半包主要原因"></a>粘包/半包主要原因</h2><p>粘包的主要原因：</p>
<ul>
<li>发送方每次写入数据 &lt; 套接字缓冲区大小</li>
<li>接收方读取套接字缓冲区数据不够及时</li>
</ul>
<p>半包的主要原因：</p>
<ul>
<li>发送方每次写入数据 &gt; 套接字缓冲区大小</li>
<li>发送的数据大于协议的 MTU（Maximum Transmission Unit，最大传输单元），必须拆包</li>
</ul>
<p>从收发角度看：一次发送可能被多次接收（半包），多个发送可能被一次接收（粘包）<br>从传输角度看：一个发送可能占用多个传输包（半包），多个发送可能公用一个传输包（粘包）</p>
<p><strong>根本原因：TCP 协议是流式协议，消息无边界。</strong>（UDP 像邮寄的包裹，虽然一次运输多个，但每个包裹都有“界限”，是一个一个签收的，所以使用 UDP 协议不会出现粘包/半包问题）</p>
<h2 id="粘包-半包解决思路"><a href="#粘包-半包解决思路" class="headerlink" title="粘包/半包解决思路"></a>粘包/半包解决思路</h2><p>要解决 TCP 粘包/半包问题，根本手段在于<strong>找出消息边界</strong>，下表列举了一些常见的解决方式。</p>
<table>
<thead>
<tr>
<th align="center">方式\比较</th>
<th align="center">寻找消息边界的方式</th>
<th align="center">优点</th>
<th align="center">缺点</th>
<th align="center">推荐度</th>
</tr>
</thead>
<tbody><tr>
<td align="center">TCP 连接改成短连接，一个请求一个短连接</td>
<td align="center">建立连接到释放连接之间的信息即为传输信息</td>
<td align="center">简单</td>
<td align="center">效率低下</td>
<td align="center">不推荐</td>
</tr>
<tr>
<td align="center">封装成帧（Framing）：固定长度</td>
<td align="center">满足固定长度即可</td>
<td align="center">简单</td>
<td align="center">空间浪费</td>
<td align="center">不推荐</td>
</tr>
<tr>
<td align="center">封装成帧（Framing）：分隔符</td>
<td align="center">分隔符之间</td>
<td align="center">空间不浪费，也比较简单</td>
<td align="center">内容本身出现分隔符时需转义，所以需要扫描内容</td>
<td align="center">推荐</td>
</tr>
<tr>
<td align="center">封装成帧（Framing）：固定长度字段存内容的长度信息</td>
<td align="center">先解析固定长度的字段获取长度，然后读取后续内容</td>
<td align="center">精确定位用户数据，内容也不用转义</td>
<td align="center">长度理论上有限制，需提前预知可能的最大长度从而定义长度占用字节数</td>
<td align="center">推荐</td>
</tr>
<tr>
<td align="center">封装成帧（Framing）：其它方式</td>
<td align="center">每种都不同，例如 JSON 可以看 {} 是否已经成对</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h2 id="Netty-对三种常用封帧方式的支持"><a href="#Netty-对三种常用封帧方式的支持" class="headerlink" title="Netty 对三种常用封帧方式的支持"></a>Netty 对三种常用封帧方式的支持</h2><table>
<thead>
<tr>
<th align="center">方式\支持</th>
<th align="center">解码</th>
<th align="center">编码</th>
</tr>
</thead>
<tbody><tr>
<td align="center">固定长度</td>
<td align="center">FixedLengthFrameDecoder</td>
<td align="center">简单</td>
</tr>
<tr>
<td align="center">分隔符</td>
<td align="center">DelimiterBasedFrameDecoder</td>
<td align="center">简单</td>
</tr>
<tr>
<td align="center">固定长度字段存内容的长度信息</td>
<td align="center">LengthFieldBasedFrameDecoder</td>
<td align="center">LengthFieldPrepender</td>
</tr>
</tbody></table>
<p>上面三种解码器都继承自 ByteToMessageDecoder。</p>
<p>下面以“固定长度字段存内容的长度信息”这种方式来演示如何在 Netty 中使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一次解码器：处理粘包/半包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFrameDecoder</span> <span class="keyword">extends</span> <span class="title">LengthFieldBasedFrameDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderFrameDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Integer.MAX_VALUE, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一次编码器：处理粘包/半包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFrameEncoder</span> <span class="keyword">extends</span> <span class="title">LengthFieldPrepender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderFrameEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/07/Netty%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5-%E4%B8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="晴天">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OnePiece">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/07/Netty%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5-%E4%B8%8B/" class="post-title-link" itemprop="url">Netty开发实践-下</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-07 21:54:00" itemprop="dateCreated datePublished" datetime="2020-02-07T21:54:00+08:00">2020-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-09 12:39:51" itemprop="dateModified" datetime="2020-02-09T12:39:51+08:00">2020-02-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Netty/" itemprop="url" rel="index">
                    <span itemprop="name">Netty</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在<a href="https://cdrcool.github.io/2020/02/07/Netty%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5-%E4%B8%8A/" target="_blank" rel="noopener">Netty开发实践-上</a>中，我们通过一些示例介绍了如何使用 Netty 进行服务器端/客户端编程，虽然我在示例代码中都做了注释，但是为了更深入的掌握 Netty 编程，接下来我们再做一些知识点梳理，其中有些知识点在前面已经用到了，有些知识点没有用到但仍是我们需要了解的。</p>
<h3 id="IO-模型切换"><a href="#IO-模型切换" class="headerlink" title="IO 模型切换"></a>IO 模型切换</h3><p>我们知道，IO 模型分为：BIO、NIO 和 AIO 三种。在 Netty 中，AIO 相关代码已经移除，BIO 相关代码虽然保留，但是已经不再推荐，也就是说，在以后的 Netty 中，我们可能只能以 NIO 的方式进行编程。<br>在之前的示例代码中，我们选择的都是 NIO 模型，如下面这样：</p>
<p><strong>服务器端：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap().channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)...</span></span><br></pre></td></tr></table></figure>

<p><strong>客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap().channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)...</span></span><br></pre></td></tr></table></figure>

<p>那如果我们一定要用 BIO 模型，又该怎么切换呢？跟简单，只需要调整相关类名即可：</p>
<p><strong>服务器端：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> OioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> OioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().channel(OioServerSocketChannel<span class="class">.<span class="keyword">class</span>)...</span></span><br></pre></td></tr></table></figure>

<p><strong>客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup group = <span class="keyword">new</span> OioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap().channel(OioSocketChannel<span class="class">.<span class="keyword">class</span>)...</span></span><br></pre></td></tr></table></figure>

<h3 id="Reactor-模式切换"><a href="#Reactor-模式切换" class="headerlink" title="Reactor 模式切换"></a>Reactor 模式切换</h3><p>在 NIO 模型中，它使用开发模式我们称之为 Reactor 模式。Reactor 模式分为：单线程 Reactor 模式、多线程 Reactor 模式 和 主从 Reactor 模式 三种。<br>在之前的示例代码中，我们选择的都是 主从 Reactor 模式，如下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().group(bossGroup, workerGroup)...</span><br></pre></td></tr></table></figure>

<p>那如果我们想要使用单线程 Reactor 模式或 多线程 Reactor 模式，又该怎么切换呢？跟简单，只需要调整相关参数即可：</p>
<p><strong>使用单线程 Reactor 模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().group(eventLoopGroup)...</span><br></pre></td></tr></table></figure>

<p><strong>使用多线程 Reactor 模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap().group(eventLoopGroup)...</span><br></pre></td></tr></table></figure>

<h2 id="粘包-半包处理"><a href="#粘包-半包处理" class="headerlink" title="粘包/半包处理"></a>粘包/半包处理</h2><p>为了处理 TCP 的粘包/半包问题，Netty 提供了三种常用的封帧方式：<br>方式\支持 | 解码 | 编码<br>:-: | :-: | :-:<br>固定长度 | FixedLengthFrameDecoder | 简单<br>分隔符 | DelimiterBasedFrameDecoder | 简单<br>固定长度字段存内容的长度信息 | LengthFieldBasedFrameDecoder | LengthFieldPrepender</p>
<p>上面三种解码器都继承自 ByteToMessageDecoder。</p>
<p>在之前的示例代码中，我们选择的都是“固定长度字段存内容的长度信息”方式，如下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一次解码器：处理粘包/半包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFrameDecoder</span> <span class="keyword">extends</span> <span class="title">LengthFieldBasedFrameDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderFrameDecoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Integer.MAX_VALUE, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一次编码器：处理粘包/半包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFrameEncoder</span> <span class="keyword">extends</span> <span class="title">LengthFieldPrepender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderFrameEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于另外两种都不常用，这里就不演示怎么切换了。</p>
<h2 id="序列化-反序列化"><a href="#序列化-反序列化" class="headerlink" title="序列化/反序列化"></a>序列化/反序列化</h2><p>Netty 对一些常用的序列化/反序列化方式都提供了支持，如 base64、bytes、compression、json、marshaling、protobuf、serialization、string、xml 等，编码器都继承自 MessageToMessageEncoder<I>，解码器都继承自 MessageToMessageDecoder<I>。</p>
<p>在之前的示例代码中，我们选择的都是 json 方式，如下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二次解码器：将 &#123;<span class="doctag">@link</span> ByteBuf&#125; 解析为 &#123;<span class="doctag">@link</span> RequestMessage&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderProtocolDecoder</span> <span class="keyword">extends</span> <span class="title">MessageToMessageDecoder</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg, List&lt;Object&gt; out)</span> </span>&#123;</span><br><span class="line">        RequestMessage requestMessage = <span class="keyword">new</span> RequestMessage();</span><br><span class="line">        requestMessage.decode(msg);</span><br><span class="line"></span><br><span class="line">        out.add(requestMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 二次编码器：将 &#123;<span class="doctag">@link</span> ResponseMessage&#125; 解析为 &#123;<span class="doctag">@link</span> ByteBuf&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderProtocolEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToMessageEncoder</span>&lt;<span class="title">ResponseMessage</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, ResponseMessage msg, List&lt;Object&gt; out)</span> </span>&#123;</span><br><span class="line">        ByteBuf byteBuf = ctx.alloc().buffer();</span><br><span class="line">        msg.encode(byteBuf);</span><br><span class="line"></span><br><span class="line">        out.add(byteBuf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息对象基类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseMessage</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">BaseMessageBody</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MessageHeader header;</span><br><span class="line">    <span class="keyword">private</span> T body;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编码消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteBuf 存储编码后的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ByteBuf byteBuf)</span> </span>&#123;</span><br><span class="line">        byteBuf.writeInt(header.getVersion());</span><br><span class="line">        byteBuf.writeLong(header.getStreamId());</span><br><span class="line">        byteBuf.writeInt(header.getOpcode());</span><br><span class="line">        byteBuf.writeBytes(JsonUtil.toJson(body).getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 opcode 获得对应的 MessageBody</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> opcode 操作码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Class&lt;T&gt; <span class="title">getMessageBodyDecodeClass</span><span class="params">(<span class="keyword">int</span> opcode)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg 解码前的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ByteBuf msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> version = msg.readInt();</span><br><span class="line">        <span class="keyword">long</span> streamId = msg.readLong();</span><br><span class="line">        <span class="keyword">int</span> opcode = msg.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.header = MessageHeader.builder()</span><br><span class="line">                .version(version)</span><br><span class="line">                .streamId(streamId)</span><br><span class="line">                .opcode(opcode)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.body = JsonUtil.fromJson(msg.toString(StandardCharsets.UTF_8), getMessageBodyDecodeClass(opcode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在其它官方示例中，演示了如果使用其它方式的编解码，如在 “Word Clock”示例中，演示了如何使用 protobuf，大家可以自行查看相关代码。</p>
<h2 id="空闲监测"><a href="#空闲监测" class="headerlink" title="空闲监测"></a>空闲监测</h2><p>在应用程序运行中，为了避免一些不怀好意或者无所事事的客户端一直和我们的应用程序保持连接，从而给我们造成资源浪费，因此一般我们都会进行空闲监测。<br>在 Netty 中，实现空闲监测的核心类是 IdleStateHandler。在前面的订单示例中，我们已经用到了这个类，现在再来回顾下是如何使用它的。</p>
<p><strong>服务端读监测：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read Idle Handler</span></span><br><span class="line"><span class="comment"> * 服务器 10s 接收不到 channel 的请求就断掉连接：保护自己、瘦身（及时清理空闲的连接）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerIdleCheckHandler</span> <span class="keyword">extends</span> <span class="title">IdleStateHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerIdleCheckHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelIdle</span><span class="params">(ChannelHandlerContext ctx, IdleStateEvent evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是第一次 read idle，就断掉连接</span></span><br><span class="line">        <span class="keyword">if</span> (evt == IdleStateEvent.FIRST_READER_IDLE_STATE_EVENT) &#123;</span><br><span class="line">            log.info(<span class="string">"Idle check happen, so close the connection"</span>);</span><br><span class="line">            ctx.close();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因此做了自定义处理，就不再触发该事件</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是其它事件，保持触发</span></span><br><span class="line">        <span class="keyword">super</span>.channelIdle(ctx, evt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端写监测：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Write Idle Handler</span></span><br><span class="line"><span class="comment"> * 客户端 5s 不发送数据就触发一个写空闲事件</span></span><br><span class="line"><span class="comment"> * 配合&#123;<span class="doctag">@link</span> KeepaliveHandler&#125;使用，以避免连接被断，同时启用不频繁的 keepalive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientIdleCheckHandler</span> <span class="keyword">extends</span> <span class="title">IdleStateHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientIdleCheckHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端写超时，发送 keepalive：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 捕捉写空闲事件：发一个 keepalive</span></span><br><span class="line"><span class="comment"> * 配合&#123;<span class="doctag">@link</span> ClientIdleCheckHandler&#125;使用，以避免连接被断，同时启用不频繁的 keepalive</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 因为不涉及内存共享，所以设置为可共享的&#123;<span class="doctag">@link</span> io.netty.channel.ChannelHandler.Sharable&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeepaliveHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 捕捉第一次写空闲事件，发送 keepalive</span></span><br><span class="line">        <span class="keyword">if</span> (evt == IdleStateEvent.FIRST_WRITER_IDLE_STATE_EVENT) &#123;</span><br><span class="line">            log.info(<span class="string">"Write Idle happen, so need to send keepalive to keep connection not closed by server"</span>);</span><br><span class="line">            KeepaliveOperation operation = <span class="keyword">new</span> KeepaliveOperation();</span><br><span class="line">            RequestMessage message = <span class="keyword">new</span> RequestMessage(IdUtil.nextId(), operation);</span><br><span class="line">            ctx.writeAndFlush(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调优参数"><a href="#调优参数" class="headerlink" title="调优参数"></a>调优参数</h2><h3 id="System-参数"><a href="#System-参数" class="headerlink" title="System 参数"></a>System 参数</h3><ul>
<li><p>ulimit<br>Linux Option。进行 TCP 连接时，系统为每个 TCP 连接创建一个 socket 句柄，也就是一个文件句柄，但是 Linux 对每个进程打开的文件句柄数量做了限制，如果超出，报错“Too many open file”。<br>注意：ulimit 命令修改的数值<strong>只对当前登录用户</strong>的目前使用环境有效，系统重启或者用户退出后就会失效，所以可以作为程序启动脚本的一部分，让它在程序启动前执行。</p>
</li>
<li><p>TCP_NODELAY<br>SocketChannel 参数。设置是否启用 Nagle 算法：通过将小的碎片数据连接成更大的报文来提高发送效率。如果需要发送一些较小的报文，则需要禁用该算法。默认不开启。 </p>
</li>
<li><p>SO_BACKLOG<br>ServerSocketChannel 参数。最大的等待连接数量。当服务器请求处理线程全满时，用于临时存放已完成三次握手的请求的队列的最大长度。默认值 128。</p>
</li>
<li><p>SO_REUSEADDR<br>SocketChannel/ServerSocketChannel 参数。地址重用，解决“Address already in use”。常用开启场景：多网卡（IP）绑定相同端口；让关闭连接释放的端口更早可使用。默认不开启。</p>
</li>
</ul>
<h3 id="Netty-参数"><a href="#Netty-参数" class="headerlink" title="Netty 参数"></a>Netty 参数</h3><ul>
<li><p>CONNECT_TIMEOUT_MILLIS<br>SocketChannel 参数。客户端连接服务器最大允许时间。默认值 30s。</p>
</li>
<li><p>io.netty.eventLoopThreads<br>System 参数。IO Thread 数量。默认值 availableProcessors * 2。</p>
</li>
<li><p>io.netty.availableProcessors<br>System 参数。指定 availableProcessors。考虑 Docker/VM 等情况。</p>
</li>
<li><p>io.netty.leakDetection.level<br>System 参数。内存泄漏检测级别：DISABLED/SIMPLE 等。默认值 SIMPLE。</p>
</li>
</ul>
<h2 id="跟踪诊断"><a href="#跟踪诊断" class="headerlink" title="跟踪诊断"></a>跟踪诊断</h2><h3 id="设置线程名"><a href="#设置线程名" class="headerlink" title="设置线程名"></a>设置线程名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>, <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"boss"</span>));</span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">0</span>, <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"worker"</span>));</span><br></pre></td></tr></table></figure>

<h3 id="设置-Handler-名"><a href="#设置-Handler-名" class="headerlink" title="设置 Handler 名"></a>设置 Handler 名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="string">"frameDecoder"</span>, <span class="keyword">new</span> OrderFrameDecoder());</span><br></pre></td></tr></table></figure>

<h3 id="使用日志"><a href="#使用日志" class="headerlink" title="使用日志"></a>使用日志</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不同位置输出的内容不同</span></span><br><span class="line">pipeline.addLast(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO));</span><br></pre></td></tr></table></figure>

<h2 id="优化使用"><a href="#优化使用" class="headerlink" title="优化使用"></a>优化使用</h2><h3 id="整改线程模型"><a href="#整改线程模型" class="headerlink" title="整改线程模型"></a>整改线程模型</h3><p>对于 IO 密集型应用，我们通常需要整改线程模型：独立出“线程池”来处理业务（处理业务的线程不再与 NioEventLoop 共享）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于 IO 密集型应用，独立出“线程池”来处理业务（这里不能使用 NioEventLoopGroup，不然只会使用到 1 个线程）</span></span><br><span class="line">EventExecutorGroup eventExecutors = <span class="keyword">new</span> UnorderedThreadPoolEventExecutor(<span class="number">1</span>, <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"business"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 业务处理 Handler 放到最后添加</span></span><br><span class="line">pipeline.addLast(eventExecutors, <span class="keyword">new</span> OrderServerProcessHandler());</span><br></pre></td></tr></table></figure>

<h3 id="增强写，延迟与吞吐量的抉择"><a href="#增强写，延迟与吞吐量的抉择" class="headerlink" title="增强写，延迟与吞吐量的抉择"></a>增强写，延迟与吞吐量的抉择</h3><p>在前面的点单示例中，我们调用的是<code>ctx.writeAndFlush(msg)</code>：写数据之后立刻发送出去，这样虽然延迟降低了，但是吞吐量又会受影响下降。如果我们是要吞吐量优先，那么有下面两种改进方式。</p>
<ul>
<li>利用 channelReadComplete<br>就像我们在 echo 示例中演示的这样：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handler implementation for the echo server.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到消息时触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 返回消息给客户端</span></span><br><span class="line">        ctx.write(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息读取完毕后触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发生异常时触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Close the connection when an exception is raised.</span></span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过使用 channelReadComplete 也有弊端：</p>
<ol>
<li><p>不适合异步业务线程（不复用 Nio event loop）处理<br>channelRead 中的业务处理结果的 write 很可能发生在 channelReadComplete 之后。</p>
</li>
<li><p>不适合更精细的控制<br>例如连续读 16 次时，第 16 次是 flush，但是如果保持连续的次数不变，如何做到 3 次就 flush ？</p>
</li>
</ol>
<ul>
<li>使用 flushConsolidationHandler<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读 5 次之后才 flush，并开启异步增强</span></span><br><span class="line">pipeline.addLast(<span class="keyword">new</span> FlushConsolidationHandler(<span class="number">5</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 业务处理 Handler 放到最后添加</span></span><br><span class="line">pipeline.addLast(eventExecutorGroup, <span class="keyword">new</span> OrderServerProcessHandler());</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="流量整形"><a href="#流量整形" class="headerlink" title="流量整形"></a>流量整形</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局流量整形</span></span><br><span class="line">GlobalTrafficShapingHandler globalTrafficShapingHandler = <span class="keyword">new</span> GlobalTrafficShapingHandler(</span><br><span class="line">        <span class="keyword">new</span> NioEventLoopGroup(), <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用流量整形</span></span><br><span class="line"><span class="comment">// 只会处理 ByteBuf，因此要注意放置的位置</span></span><br><span class="line">pipeline.addLast(globalTrafficShapingHandler);</span><br></pre></td></tr></table></figure>

<h3 id="为不同平台开启-native"><a href="#为不同平台开启-native" class="headerlink" title="为不同平台开启 native"></a>为不同平台开启 native</h3><p>Netty 针对不同平台都做了一定的优化，如果我们想切换到特定平台，也是非常方便的。</p>
<ul>
<li>修改代码<ul>
<li>NioServerSocketChannel -&gt; [Prefix]ServerSocketChannel</li>
<li>NioEventLopGroup -&gt; [Prefix]EventLopGroup</li>
<li>NioChannelOption -&gt; [Prefix]ChannelOption</li>
</ul>
</li>
<li>准备好 native 库</li>
</ul>
<h2 id="黑白名单"><a href="#黑白名单" class="headerlink" title="黑白名单"></a>黑白名单</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 黑白名单过滤</span></span><br><span class="line">IpSubnetFilterRule ipSubnetFilterRule =<span class="keyword">new</span> IpSubnetFilterRule(<span class="string">"127.0.0.1"</span>, <span class="number">8</span>,</span><br><span class="line">        IpFilterRuleType.REJECT);</span><br><span class="line">RuleBasedIpFilter ruleBasedIpFilter = <span class="keyword">new</span> RuleBasedIpFilter(ipSubnetFilterRule);ine();</span><br><span class="line">                                                                                </span><br><span class="line"><span class="comment">// 黑白名单过滤</span></span><br><span class="line">pipeline.addLast(ruleBasedIpFilter);</span><br></pre></td></tr></table></figure>

<h2 id="自定义授权"><a href="#自定义授权" class="headerlink" title="自定义授权"></a>自定义授权</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证处理 Handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ChannelHandler</span>.Sharable</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RequestMessage</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RequestMessage msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BaseOperation operation = msg.getBody();</span><br><span class="line">            <span class="keyword">if</span> (operation <span class="keyword">instanceof</span> AuthOperation) &#123;</span><br><span class="line">                AuthOperation authOperation = (AuthOperation) operation;</span><br><span class="line">                AuthOperationResult authOperationResult = authOperation.execute();</span><br><span class="line">                <span class="keyword">if</span> (authOperationResult.isPassAuth()) &#123;</span><br><span class="line">                    log.info(<span class="string">"Pass auth"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.error(<span class="string">"Fail to auth"</span>);</span><br><span class="line">                    ctx.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">"Expect first msg is auth"</span>);</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"Exception happen"</span>);</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 只处理一次，处理后移除</span></span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            ctx.pipeline().remove(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server 端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 认证处理</span></span><br><span class="line">AuthHandler authHandler = <span class="keyword">new</span> AuthHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 认证处理</span></span><br><span class="line">pipeline.addLast(authHandler);</span><br></pre></td></tr></table></figure>

<p>Client 端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 做了认证处理，要求第一个操作是认证操作</span></span><br><span class="line">channelFuture.channel().writeAndFlush(<span class="keyword">new</span> RequestMessage(IdUtil.nextId(),</span><br><span class="line">        <span class="keyword">new</span> AuthOperation(<span class="string">"admin"</span>, <span class="string">"password"</span>)));</span><br><span class="line">channelFuture.channel().writeAndFlush(requestMessage);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">晴天</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">晴天</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
